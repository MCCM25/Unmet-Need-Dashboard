# Financial Vulnerability Index 

# Datasets: Housing arrears, Foodbank use, Council Tax reduction (pending) and 
# *Council Tax arrears
# *Council Tax arrears is for all households, therefore is weighted by % households with children
#  to be more representative.


# libraries
library(tidyverse)
library(readxl)

# Read in data-----------------------------------------------------------

# FVI measure numbers
FVI_no <- list.files("Data/FVI Numbers/", full.names = TRUE) %>% 
  map(., read_xlsx) %>% 
  list_rbind() %>% select(-publication_year)

# FVI measure denominators
FVI_denominators <- list.files("Data/FVI denominators/", full.names = TRUE) %>% 
  map(., read_xlsx) %>% 
  list_rbind() %>% select(-publication_year)

# calculate rates for FVI measures using FVI_no/FVI_denominators
FVI_rates <- FVI_no %>%
  merge(FVI_denominators) %>%
  # FVI measure rate then calculated
  mutate(FVI_measure_rate = FVI_measure_number/FVI_denominator_number) %>%
  # Replace rates where num and den are 0
  mutate(FVI_measure_rate = case_when(FVI_measure_rate == "NaN"|FVI_measure_rate == "Inf" ~ 0 ,
                                      .default = FVI_measure_rate))

# Calculate FV index-----------------------------------------------------------

FV_index_df <- FVI_rates %>% 
  select(Datazone, FVI_measure, FVI_measure_rate, display_year) %>%
  pivot_wider(names_from = "FVI_measure", values_from = "FVI_measure_rate") %>% 
  # Calculate z score for each measure
  mutate(across(c(-Datazone, -display_year),
                ~as.numeric(scale(.)),
                .names = "z_{col}")) %>%
  select(Datazone, display_year, starts_with("z_")) %>%
  pivot_longer(cols = starts_with("z_"),
               names_to = "FVI_measure", 
               values_to = "z_scores") %>%
  # Add column to assign weights, foodbank and housing arrears weighed double to 
  # council tax arrears as this is for all households, not just housheolds with children
  # weights may need changing as more indicators are added
  mutate("weights" = if_else(FVI_measure == "z_HH_with_ctax_arrears", 1, 2)) %>%
  mutate("weighted_score" = z_scores * weights) %>%
  group_by(Datazone, display_year) %>%
  # Calculate combined weighted average z score
  summarise("demand_rate" = sum(weighted_score) / sum(weights)) %>%
  mutate(demand_measure = "FV_index") 

# write to xlsx
writexl::write_xlsx(FV_index_df, 
                    "Data/Precalculated demand rates/financial vulnerability index.xlsx")
